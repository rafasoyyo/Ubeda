extends layout

block head
    style.
        main p,
        main span,
        main e,
        main i {
            font-size: 15px;
        }
        #map {
            width: 100%;
            height: calc(70vh - 45px);
        }

        #placeInfo {
            max-width: calc(100vw - 20px);
            width: 780px;
            height: calc(100vh - 20px);
            top: 10px;
            margin: 0 10px;
            display: block;
            padding: 0;
            z-index: 10;
            position: fixed;
            background-color: white;
            box-shadow: 0 0 10px 1px grey;
            overflow-x: auto;
            color: #607D8B;
        }

        #placeInfo .close {
            position: absolute;
            top: 0;
            right: 0;
            margin: 15px 20px;
            font-size: 20px;
        }

        #placeInfo a {
            //- padding: 0 10px;
            text-decoration: none;
        }

        #placeInfo > div > div{
            margin-bottom: 10px;
        }

        #placeInfo button {
            padding: 7px 15px;
            color: #607D8B;
            border: 1px solid #607D8B;
            font-size: 11px;
            min-width: 48%;
            max-width: 98%;
            margin: 1%;
            background-color: white;
        }

        #placeInfo span,
        #placeInfo i {
            padding: 0 3px;
            font-size: 13px;
            color: #607D8B;
        }

        #placeInfo .images {
            margin: 15px;
            max-width: calc(100vw - 20px);
            overflow: scroll;
            -webkit-overflow-scrolling: touch;
        }

        #placeInfo .image {
            max-width: 75vw;
            min-width: 50vw;
            max-height: 75vh;
            display: inline;
            vertical-align: middle;
            margin-right: 10px;
        }

        #places {
            height: calc(30vh - 5px);
            box-sizing: border-box;
            overflow-x: scroll;
            overflow-y: hidden;
            margin: 5px 5px 0px 5px;
            -webkit-overflow-scrolling: touch;
        }

        #places .scroll-places {
            height: calc(100% - 5px);
        }

        .place {
            height: 100%;
            width: 61vw;
            max-width: 300px;
            min-width: 240px;
            margin-right: 10px;
            display: inline-block;
            box-sizing: border-box;
            vertical-align: top;
            border: 1px solid rgba(0, 0, 0, 0.15);
            box-shadow: 1px 1px 5px -1px black;
        }

        .place-box{
            height: 40%;
            margin: 2% 5%;
        }

        .place-box h3 {
            font-size: 15px;
            font-weight: bold;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: auto;
        }

        .place-box em,
        .place-box i {
            font-size: 11px;
        }

        .place-box button {
            border: 1px;
            padding: 4px 15px;
            color: white;
            background-color: #607D8B;
            font-size: 11px;
        }

        .place-background {
            height: 60%;
            max-height: calc(100% - 70px);
        }

block content
    .page
        header#header
            a(href="/")
                i.fas.fa-chevron-left(style="position: absolute; top: 0; left: 0; margin: 15px")
            h2(style=" margin: 5px 0;")= title
            i.fas.fa-map-marker-alt(style="position: absolute; top: 0; right: 0; margin: 15px" onclick="gps()")

        main
            #map

            #placeInfo(style="display: none")
                .close.fa.fa-times()
                .text-center(style="padding: 10px 20px")
                    div
                        h1.name
                    div
                        a.info(style="line-height: 20px;" target="_bank")
                    button
                        a.phone(target="_bank")
                            i.fa.fa-phone
                            span
                    button
                        a.web(target="_bank")
                            i.fa.fa-link
                            span Web
                    button
                        a.unmar.address(target="_bank")
                            i.fas.fa-map-marked-alt
                            span
                .images
                    .scroll-images

            #places
                .scroll-places
                    for place in places
                        .place(data-identifier="#{place.id}" data-info="#{place.info}")
                            .place-background.background
                            .place-box
                                h3.unmar.bold= place.name
                                em.unmar= place.type
                                span(style="padding:0 4px") ·
                                em.rating
                                i.fa.fa-star(style="padding-left: 2px")
                                if place.recomendation
                                    span(style="padding:0 4px") ·
                                    em= place.recomendation
                                div(style=" text-align: center; ")
                                    button(onclick="placeDetails(this)" style=" border: 1px solid grey; margin: 5px;") De interés

block scripts
    script(src="//maps.googleapis.com/maps/api/js?key=AIzaSyDOUok9C5sAw7TY0Uvba7Bn63YoTJjt0CU&libraries=places&callback=initMap" async defer)
    //- script(src="https://maps.googleapis.com/maps/api/js?libraries=places&callback=initMap" async defer)

    script.
        var map, geolocation, isLocated, myMarker, myAccuracy;
        var placeService, placeMarker, placesInfo = {};
        var $places, $placeInfo;

        //- Iniciar mapa y su configuración
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: new google.maps.LatLng( 38.008700, -3.369500),
                disableDefaultUI: true,
                zoom: 16,
                mapTypeControlOptions: {
                    mapTypeIds: ['styled_map']
                }
            });
            //Associate the styled map with the MapTypeId and set it to display.
            map.mapTypes.set('styled_map', new google.maps.StyledMapType([
                {
                    "featureType": "poi",
                    "elementType": "labels.text",
                    "stylers": [
                    {
                        "visibility": "off"
                    }
                    ]
                },
                {
                    "featureType": "poi.business",
                    "stylers": [
                    {
                        "visibility": "off"
                    }
                    ]
                },
                {
                    "featureType": "road",
                    "elementType": "labels.icon",
                    "stylers": [
                    {
                        "visibility": "off"
                    }
                    ]
                },
                {
                    "featureType": "transit",
                    "stylers": [
                    {
                        "visibility": "off"
                    }
                    ]
                }
            ]));
            map.setMapTypeId('styled_map');

            placeService = new google.maps.places.PlacesService(map);
            findPlace(0);
        }

        function setPlaces(element, place) {
            place = JSON.parse(place);
            //- console.log(place)
            var placeId = place._id;
            placeMarker = new google.maps.Marker({
                'icon': {
                    'url': place.icon,
                    'scaledSize': new google.maps.Size(25, 25),
                },
                'position': {
                    lat: place.lat,
                    lng: place.lng
                },
                'map': map
            });
            placeMarker._id = placeId;
            placeMarker.addListener('click', function() {
                placeFocus(this._id);
            });

            placesInfo[placeId] = place;
            placesInfo[placeId].marker = placeMarker;

            element.attr('id', placeId);
            element.data('placeid', placeId);
            element.find('.rating').text(place.rating);
            if (place.photo) {
                element.children('.place-background').css({ 'background-image': 'url(' + place.photo + ')' });
            } else {
                element.children('.place-background').css({ 'background-image': 'url(/images/default.jpg)' });
            }
            element.click(function(){
                console.log(element, element.data(), element.data(placeId));
                placeFocus(element.data('placeid'));
            });
        }

        //- Buscar datos de lugares
        function findPlace(i) {

            var p = $('.place')[i];
            if(!p) { return false; }

            var that = $(p);
            var data = that.data();
            var identifier = data.identifier.replace(/[^a-zA-Z]/g, '');

            var today = new Date().getDate();
            var localData = localStorage.getItem(identifier);
            if(localData && today%4 === 0){
                console.log(data.identifier, 'local', today, today%4 === 0);
                setPlaces(that, localData);
                findPlace(++i);
            } else {
                console.log(data.identifier, 'cloud', today, today%4 != 0);
                placeService.findPlaceFromQuery({
                    query: data.identifier,
                    fields: ['place_id', 'photo', 'name', 'rating', 'opening_hours', 'geometry', 'icon']
                }, function(res, status) {
                    if (status == google.maps.places.PlacesServiceStatus.OK) {
                        res = res[0];
                        var placeData = JSON.stringify({
                            _id: res.place_id,
                            name: identifier,
                            icon: res.icon,
                            lat: res.geometry.location.lat(),
                            lng: res.geometry.location.lng(),
                            photo: res.photos[0].getUrl(),
                            rating: res.rating
                        });
                        //- console.log(identifier, placeData);
                        setPlaces(that, placeData);
                        localStorage.setItem(identifier, placeData);
                        findPlace(++i);
                    } else {
                        console.log('getDetails: ', identifier, status)
                        setTimeout(function(){
                            findPlace(i);
                        }, 1000);
                    }
                });
            }
        }


        function placeDetails (t){
            var data = $(t).closest('.place').data();
            placeService.getDetails({
                placeId: data.placeid,
                fields: ['place_id', 'website', 'formatted_phone_number', 'photos', 'formatted_address', 'name']
            }, function(res, status) {
                console.log(status, res, data)
                if (status == google.maps.places.PlacesServiceStatus.OK) {

                    var images = '';
                    if (res.photos && res.photos.length) {
                        (res.photos).forEach(function(img){
                            images += '<img class="image" src=" ' + img.getUrl() + ' "></img>';
                            $placeInfo.find('.scroll-images').width( (($(window).width() * 0.77) + 11) * res.photos.length );
                        });
                    } else {
                        images += '<img class="image" src="/images/default.jpg"></img>';
                        $placeInfo.find('.scroll-images').width( (($(window).width() * 0.9) ));
                    }

                    $placeInfo
                        .find('.scroll-images')
                            .html(images)
                        .end()
                        .find('.info')
                            .text( (data.info && data.info.length && data.info !== 'undefined') ? data.info : '' )
                        .end()
                        .find('.name')
                            .text(res.name)
                        .end()
                        .find('.phone')
                            .attr('href', 'tel: ' + res.formatted_phone_number)
                            .find('span')
                                .text(res.formatted_phone_number)
                            .end()
                        .end()
                        .find('.web')
                            .attr('href', res.website)
                            //- .find('span')
                            //-     .text('Enlace')
                            //- .end()
                        .end()
                        .find('.address')
                            .attr('href', "http://maps.google.com/?q=" + res.name + ' ' + res.formatted_address)
                            .find('span')
                                .text(res.formatted_address)

                    $placeInfo.show()
                    gtag('event', 'place_interest', {
                        'event_category': 'visit',
                        'event_label': res.name,
                        'value': res.name,
                    });
                } else {
                    console.error('Place not found: ', data);
                }
            });
        }


        function placeFocus(placeid){
            var icon;
            //- Set original state to all markers
            Object.keys(placesInfo).forEach(function(item){
                icon = placesInfo[item].marker.getIcon();
                placesInfo[item].marker.setIcon({
                    'url': icon.url,
                    'scaledSize': new google.maps.Size(25, 25)
                });
                placesInfo[item].marker.setZIndex(1);
            });

            var place = placesInfo[placeid];
            var item = $places.find('#' + placeid);
            if (item) {
                $places.animate({ scrollLeft: item.offset().left - item.parent().offset().left }, 500);
            }
            map.panTo({
                lat: place.lat,
                lng: place.lng
            });
            icon = place.marker.getIcon();
            place.marker.setIcon({
                'url': icon.url,
                'scaledSize': new google.maps.Size(50, 50)
            })
            place.marker.setZIndex(10);
        }


        function gps(){
            if(geolocation) {
                navigator.geolocation.clearWatch(geolocation);
                if (myMarker) { myMarker.setMap(null); }
                if (myAccuracy) { myAccuracy.setMap(null); }
                isLocated = false;
            }
            geolocation = navigator.geolocation.watchPosition(function(position){
                var myPos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                console.log('Position: ', myPos);
                if (!isLocated) {
                    map.panTo(myPos);
                    myMarker = new google.maps.Marker({
                        'icon': {
                            'path': google.maps.SymbolPath.CIRCLE,
                            'fillColor': '#4285F4',
                            'fillOpacity': 1,
                            'scale': 6,
                            'strokeColor': 'white',
                            'strokeWeight': 2,
                        },
                        'position': myPos,
                        'map': map
                    });

                    myAccuracy = new google.maps.Circle({
                        'strokeColor': '#4285F4',
                        'strokeWeight': 2,
                        'fillColor': '#4285F4',
                        'fillOpacity': 0.3,
                        'map': map,
                        'radius': position.coords.accuracy,
                        'center': myPos,
                    });
                    isLocated = true;
                } else {
                    myAccuracy.setCenter(myPos);
                    myMarker.setPosition(myPos);
                }
            }, function(err){
                console.error('Error: ', err)
                alert( 'Ups! parece que algo no va bien... ', err.code , ' - ' , err.message );
            }, { timeout: 5000 });
        }


        $('document').ready(function(){
            $places = $('#places');
            $place  = $places.find('.place');
            $places.find('.scroll-places').width( ($place.length * ($place.outerWidth() + 10) ) + 2 );

            $placeInfo = $('#placeInfo');
            $placeInfo.find('.close').click(function(){
                $placeInfo.hide();
            })
        });
